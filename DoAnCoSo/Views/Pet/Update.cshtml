@model DoAnCoSo.Models.Pet

@{
    ViewData["Title"] = "✏️ Cập nhật thông tin thú cưng";
}

<link rel="stylesheet" href="~/css/booking.css" />

<div class="container my-5">
    <div class="booking-card mx-auto" style="max-width: 750px;">
        <h2 class="booking-title text-center mb-4">@ViewData["Title"]</h2>

        <form asp-action="Update" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="PetId" />

            <!-- Thông tin cơ bản -->
            <h5><span class="section-icon">📋</span> Thông tin cơ bản</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Name" class="form-label">Tên thú cưng</label>
                    <input asp-for="Name" class="form-control" required />
                </div>

                <div class="col-md-6">
                    <label asp-for="Type" class="form-label">Loại</label>
                    <select asp-for="Type" class="form-select" required>
                        @* <option value="">-- Chọn loại --</option> *@
                        <option value="Chó">Chó</option>
                        <option value="Mèo">Mèo</option>
                    </select>
                </div>


                <div class="col-md-6">
                    <label asp-for="Breed" class="form-label">Giống</label>
                    <input asp-for="Breed" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label asp-for="DateOfBirth" class="form-label">Ngày sinh</label>
                    <input asp-for="DateOfBirth"
                           type="text"
                           id="datePicker"
                           class="form-control" 
                           placeholder="Chọn ngày sinh..." />
                </div>

                <div class="col-md-3">
                    <label asp-for="Gender" class="form-label">Giới tính</label>
                    <select asp-for="Gender" class="form-select">
                        <option value="Male">Đực</option>
                        <option value="Female">Cái</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label asp-for="Age" class="form-label">Tuổi</label>
                    <input asp-for="Age" type="text" class="form-control" id="age" readonly />
                </div>

                <div class="col-md-6">
                    <label asp-for="Color" class="form-label">Màu sắc</label>
                    <input asp-for="Color" class="form-control" />
                </div>

                <div class="col-12">
                    <label asp-for="DistinguishingMarks" class="form-label">Dấu hiệu nhận dạng</label>
                    <input asp-for="DistinguishingMarks" class="form-control" />
                </div>
            </div>

            <!-- Thông tin thể chất -->
            <h5 class="mt-4"><span class="section-icon">⚖️</span> Thông tin thể chất</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Weight" class="form-label">Cân nặng (kg)</label>
                    <input asp-for="Weight" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label asp-for="Height" class="form-label">Chiều cao (cm)</label>
                    <input asp-for="Height" class="form-control" />
                </div>
            </div>

            <!-- Thông tin sức khỏe -->
            <h5 class="mt-4"><span class="section-icon">🩺</span> Thông tin sức khỏe</h5>
            <div class="mb-3">
                <label asp-for="VaccinationRecords" class="form-label">Hồ sơ tiêm phòng</label>
                <textarea asp-for="VaccinationRecords" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="MedicalHistory" class="form-label">Tiền sử bệnh</label>
                <textarea asp-for="MedicalHistory" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="Allergies" class="form-label">Dị ứng</label>
                <textarea asp-for="Allergies" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="DietPreferences" class="form-label">Chế độ ăn</label>
                <textarea asp-for="DietPreferences" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="HealthNotes" class="form-label">Ghi chú sức khỏe</label>
                <textarea asp-for="HealthNotes" class="form-control" rows="2"></textarea>
            </div>

            <!-- Hình ảnh -->
            <h5 class="mt-4"><span class="section-icon">📷</span> Hình ảnh</h5>
            <div class="mb-3">
                <label asp-for="ImageUrl" class="form-label">Cập nhật ảnh</label>
                <input name="imageFile" type="file" class="form-control" />
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <div class="mt-2 text-center">
                        <img src="@Model.ImageUrl" alt="Ảnh thú cưng" class="img-fluid rounded" style="max-height: 150px; border: 2px solid #FFB6C1;">
                    </div>
                }
            </div>

            <!-- Kết quả phân tích AI -->
            <div class="mb-3">
                <label asp-for="AI_AnalysisResult" class="form-label">Kết quả phân tích AI</label>
                <textarea asp-for="AI_AnalysisResult" class="form-control" rows="2" readonly></textarea>
            </div>

            <!-- Nút hành động -->
            <div class="d-flex justify-content-between mt-4">
                <a asp-action="Index" class="btn btn-secondary px-4 py-2 rounded-pill shadow-sm">← Quay lại</a>
                <button type="submit" class="btn btn-pink px-4 py-2 rounded-pill shadow-sm">💾 Cập nhật</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Ẩn mũi tên trong input type=number */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield; /* Firefox */
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ageInput = document.getElementById("age");
        const dobInput = document.getElementById("datePicker");
        if (!dobInput) return;

        // Hàm tính tuổi
        function updateAge(dob) {
            if (!dob) {
                ageInput.value = '';
                ageInput.dataset.realAge = '';
                return;
            }

            const today = new Date();
            let years = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            const d = today.getDate() - dob.getDate();

            if (m < 0 || (m === 0 && d < 0)) years--;

            ageInput.dataset.realAge = years >= 0 ? years : 0;
            ageInput.value = years > 0 ? years : "<1";
        }

        // Khởi tạo flatpickr
        const dobPicker = flatpickr(dobInput, {
            dateFormat: "Y/m/d",
            altInput: true,
            altFormat: "d/m/Y",
            locale: "vn",
            maxDate: "today",
            disableMobile: true,
            defaultDate: "@(Model.DateOfBirth?.ToString("yyyy/MM/dd"))",
            onChange: function (selectedDates) {
                if (selectedDates.length) updateAge(selectedDates[0]);
            }
        });

        // Khi load form, tính tuổi ngay nếu đã có ngày sinh
        if (dobPicker.selectedDates.length) {
            updateAge(dobPicker.selectedDates[0]);
        }

        // Khi submit form, gửi giá trị thật
        const form = ageInput.closest("form");
        if (form) {
            form.addEventListener("submit", function () {
                ageInput.value = ageInput.dataset.realAge || '';
            });
        }
    });
</script>
