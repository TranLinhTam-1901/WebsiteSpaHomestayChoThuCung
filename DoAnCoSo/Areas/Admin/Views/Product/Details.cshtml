@model DoAnCoSo.Models.Product

@{
    ViewData["Title"] = "📋 Chi tiết sản phẩm";
    var reviews = ViewBag.Reviews as List<DoAnCoSo.Models.Review> ?? new();
    var totalReviews = (int)(ViewBag.TotalReviews ?? 0);
    var averageRating = (double)(ViewBag.AverageRating ?? 0d);

    int totalVariantStock = (int)(ViewBag.TotalVariantStock ?? 0);
    int totalVariantReserved = (int)(ViewBag.TotalVariantReserved ?? 0);
    int totalVariantSold = (int)(ViewBag.TotalVariantSold ?? 0);

    int discountPct = (Model.PriceReduced.HasValue && Model.PriceReduced.Value > 0 && Model.PriceReduced.Value < Model.Price)
        ? (int)Math.Round((1 - (Model.PriceReduced.Value / Model.Price)) * 100)
        : 0;

    var flavorList = string.IsNullOrWhiteSpace(Model.Flavors)
        ? new List<string>()
        : Model.Flavors.Split(',').Select(s => s.Trim()).Where(s => s != "").ToList();
}

<link rel="stylesheet" href="~/css/booking.css" />

<div class="container my-5">
    <div class="booking-card mx-auto p-4" style="max-width: 1000px; min-width: 750px;">
        <h2 class="booking-title text-center mb-4">@ViewData["Title"]</h2>

        <!-- Ảnh sản phẩm -->
        <div class="text-center mb-4">
            @if (!string.IsNullOrWhiteSpace(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" alt="Ảnh sản phẩm"
                     class="rounded-3 shadow-sm"
                     style="width:300px;height:300px;object-fit:cover;border:6px solid #FFB6C1;" />
            }
            else
            {
                <div class="rounded-3 d-inline-flex align-items-center justify-content-center shadow-sm"
                     style="width:300px;height:300px;background-color:#FFF0F5;border:6px solid #FFB6C1;">
                    <i class="fas fa-box fa-5x" style="color:#FF6185;"></i>
                </div>
            }
        </div>

        <!-- Thông tin cơ bản -->
        <h5><span class="section-icon">📋</span> Thông tin cơ bản</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <strong>Tên sản phẩm:</strong> @(string.IsNullOrWhiteSpace(Model.Name) ? "Chưa có" : Model.Name)
            </div>
            <div class="col-md-6 mb-3">
                <strong>Thương hiệu:</strong> @(string.IsNullOrWhiteSpace(Model.Trademark) ? "Chưa có" : Model.Trademark)
            </div>
            <div class="col-md-6 mb-3">
                <strong>Loại sản phẩm:</strong> @(Model.Category?.Name ?? "Chưa có")
            </div>
            <div class="col-md-6 mb-3">
                <strong>Giá:</strong>
                @if (Model.PriceReduced.HasValue && Model.PriceReduced.Value < Model.Price)
                {
                    <span class="text-muted text-decoration-line-through">
                        @(Math.Round(Model.Price).ToString("N0")) đ
                    </span>
                    <span class="text-danger fw-bold ms-1">
                        @(Math.Round(Model.PriceReduced.Value).ToString("N0")) đ
                    </span>
                    <span class="badge bg-success ms-1">-@discountPct%</span>
                }
                else
                {
                    <span class="fw-semibold">@(Math.Round(Model.Price).ToString("N0")) đ</span>
                }
            </div>
            @if (flavorList.Any())
            {
                <div class="col-md-6 mb-3">
                    <strong>Hương vị:</strong> @string.Join(", ", flavorList)
                </div>
            }
            <div class="col-md-6 mb-3">
                <strong>Tồn kho:</strong> @Model.StockQuantity
            </div>
        </div>

        <!-- Biến thể -->
        <h5 class="mt-4"><span class="section-icon">🔀</span> Biến thể & tồn kho</h5>
        @if (Model.Variants != null && Model.Variants.Any())
        {
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Tên</th>
                            <th>SKU</th>
                            <th>Giá override</th>
                            <th>Tồn</th>
                            <th>Đang giữ</th>
                            <th>Đã bán</th>
                            <th>Ngưỡng</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var idx = 1;
                            foreach (var v in Model.Variants.OrderBy(x => x.Name))
                            {
                                <tr>
                                    <td>@idx</td>
                                    <td>@v.Name</td>
                                    <td>@v.Sku</td>
                                    <td>@(v.PriceOverride?.ToString("N0") ?? "-")</td>
                                    <td>@v.StockQuantity</td>
                                    <td>@v.ReservedQuantity</td>
                                    <td>@v.SoldQuantity</td>
                                    <td>@v.LowStockThreshold</td>
                                    <td>@(v.IsActive ? "🟢" : "🔴")</td>
                                </tr>
                                idx++;
                            }
                        }
                    </tbody>
                    <tfoot>
                        <tr class="table-light">
                            <th colspan="4" class="text-end">Tổng:</th>
                            <th>@totalVariantStock</th>
                            <th>@totalVariantReserved</th>
                            <th>@totalVariantSold</th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info mb-0">Sản phẩm này chưa có biến thể.</div>
        }

        <!-- Reviews -->
        <h5 class="mt-4"><span class="section-icon">📝</span> Đánh giá sản phẩm</h5>
        @if (reviews.Any())
        {
            <div class="review-list border rounded-3 p-3">
                @foreach (var review in reviews)
                {
                    <div class="mb-2 border-bottom pb-2">
                        <strong class="text-pink">@review.User?.UserName</strong> - ⭐ @review.Rating<br />
                        <span>@review.Comment</span><br />
                        <small class="text-muted">@review.CreatedDate.ToString("dd/MM/yyyy HH:mm")</small>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-muted fst-italic">Chưa có đánh giá nào.</p>
        }

        <!-- Nút thao tác -->
        <div class="d-flex justify-content-between mt-4">
            <a asp-action="Index" class="btn btn-secondary px-4 py-2 rounded-pill shadow-sm">← Quay lại</a>
            <a asp-action="Update" asp-route-id="@Model.Id" class="btn btn-warning px-4 py-2 rounded-pill shadow-sm">🛠️ Sửa</a>
        </div>
    </div>
</div>
