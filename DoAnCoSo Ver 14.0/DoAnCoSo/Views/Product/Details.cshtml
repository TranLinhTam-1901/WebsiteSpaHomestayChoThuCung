@model DoAnCoSo.ViewModels.ProductDetailViewModel

<div class="container py-5">
    <div class="row">
        <!-- Hình ảnh sản phẩm -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0">
                <img id="mainProductImage" src="@Model.Product.ImageUrl" class="card-img-top" alt="Product Image">
                <div class="card-body">
                    <div class="row g-2">
                        @if (Model.Product.Images != null && Model.Product.Images.Any())
                        {
                            @foreach (var productImage in Model.Product.Images)
                            {
                                <div class="col-3">
                                    <img src="@productImage.Url"
                                         class="img-thumbnail"
                                         alt="Thumbnail"
                                         style="cursor: pointer;">
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-12 text-center text-muted">Không có ảnh phụ nào.</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Chi tiết sản phẩm -->
        <div class="col-md-6">
            <h1 class="h2 mb-3">@Model.Product.Name</h1>

            @if (TempData["ErrorMessage"] is string stockMsg)
            {
                <div class="alert alert-danger" role="alert">@stockMsg</div>
            }

            <!-- Giá -->
            <div class="mb-3">
                @if (Model.Product.PriceReduced != null && Model.Product.PriceReduced > 0 && Model.Product.PriceReduced < Model.Product.Price)
                {
                    <span class="fw-bold text-danger fs-4">@Model.Product.PriceReduced.Value.ToString("N0")đ</span>
                    <del class="text-muted">@Model.Product.Price.ToString("N0")đ</del>
                    <span class="badge bg-danger">@Model.Product.DiscountPercentage.ToString("0.##")%</span>
                }
                else
                {
                    <span class="fw-bold text-danger fs-4">@Model.Product.Price.ToString("N0")đ</span>
                }
            </div>

            <!-- Rating -->
            <div class="mb-3 d-flex align-items-center">
                <div class="text-warning me-2">
                    @{
                        double rounded = Math.Round(Model.AverageRating * 2) / 2;
                        for (int i = 1; i <= 5; i++)
                        {
                            if (rounded >= i)
                            {
                                <i class="fas fa-star"></i>
                                ;
                            }
                            else if (rounded >= i - 0.5)
                            {

                                <i class="fas fa-star-half-alt"></i>
                                ;
                            }
                            else
                            {

                                <i class="far fa-star"></i>
                                ;
                            }
                        }
                    }
                </div>
                <span class="text-muted">(@Model.TotalReviews đánh giá)</span>
            </div>

            <!-- Thương hiệu -->
            <p class="fw-semibold mb-4">
                Thương hiệu: <span class="text-primary">@Model.Product.Trademark</span>
            </p>

            <!-- Options -->
            <div class="product-detail-actions-container">
                @if (Model.Product.FlavorsList != null && Model.Product.FlavorsList.Any())
                {
                    <h6 class="mb-2">Hương vị</h6>
                    <div class="mb-3">
                        @for (int i = 0; i < Model.Product.FlavorsList.Count; i++)
                        {
                            var id = $"flavor{i}";
                            <input type="radio" class="btn-check flavor-radio" name="flavor" id="@id" value="@Model.Product.FlavorsList[i]" @(i == 0 ? "checked" : "")>
                            <label class="flavor-option-label" for="@id">@Model.Product.FlavorsList[i]</label>
                        }
                    </div>
                }
                @{
                    var stock = Model.Product?.StockQuantity ?? 0;

                    // Số lượng cho UI (không cho chọn quá 5/lần)
                    var maxUiQty = Math.Min(5, Math.Max(0, stock));

                    // Nhãn hiển thị thân thiện
                    string stockLabel = stock switch
                    {
                        0 => "Hết hàng",
                        <= 5 => $"Còn {stock}",
                        _ => "Còn hàng"
                    };
                }

                <div class="mb-4 d-flex align-items-center">
                    <label class="me-2">Số lượng</label>

                    @if (maxUiQty > 0)
                    {
                        <select class="form-select w-auto" id="quantitySelect" data-available="@stock">
                            @for (int i = 1; i <= maxUiQty; i++)
                            {
                                <option>@i</option>
                            }
                        </select>
                        <small class="ms-2 text-muted">@stockLabel</small>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Hết hàng</span>
                    }
                </div>

              
                <!-- Nút hành động -->
                <div class="d-flex gap-2">
                    <a href="#" onclick="buyNow()" class="btn btn-primary flex-grow-1 py-2">Mua Ngay</a>

                    <form id="addToCartForm"
                          asp-controller="ShoppingCart"
                          asp-action="AddToCart"
                          method="post"
                          class="flex-grow-1">
                        @Html.AntiForgeryToken()

                        <input type="hidden" name="productId" value="@Model.Product.Id" />
                        <input type="hidden" id="hiddenQuantity" name="quantity" value="1" />
                        <input type="hidden" id="hiddenFlavor" name="flavor" value="" />

                        <button type="submit" class="btn btn-outline-dark w-100">
                            <i class="bi-cart-fill me-1"></i> Thêm vào giỏ
                        </button>
                    </form>
                </div>

                @if (maxUiQty == 0)
                {
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            document.querySelectorAll('.product-detail-actions-container a.btn, .product-detail-actions-container button.btn')
                                .forEach(function (btn) { btn.disabled = true; btn.classList.add('disabled'); });
                        });
                    </script>
                }
            </div>

            <!-- Hotline -->
            <div class="mt-4 d-flex align-items-center">
                <i class="fas fa-shield-alt text-primary me-2"></i>
                <p class="mb-0">Gọi đặt mua: <strong>098.765.4321</strong> (8h30 - 22h30)</p>
            </div>
        </div>
    </div>

    <!-- Mô tả -->
    <div class="row mt-5">
        <div class="col-12">
            <h2>Mô tả sản phẩm</h2>
            <hr />
            <div class="product-description">
                @Html.Raw(Model.Product.Description ?? "<i>Sản phẩm chưa có mô tả.</i>")
            </div>
        </div>
    </div>

    <!-- Bình luận -->
    <div class="row mt-5">
        <div class="col-12">
            <h2>Bình luận & Đánh giá</h2>
            <hr />
            @if (Model.Reviews?.Any() == true)
            {
                @foreach (var review in Model.Reviews)
                {
                    <div class="review-box">
                        <p class="mb-1"><strong>@(review.User?.FullName ?? "Ẩn danh")</strong></p>
                        <div class="mb-1 text-warning">
                            @for (int i = 0; i < review.Rating; i++)
                            {
                                <i class="fas fa-star"></i>
                            }
                            @for (int i = review.Rating; i < 5; i++)
                            {
                                <i class="far fa-star"></i>
                            }
                        </div>
                        <p>@review.Comment</p>
                        @if (review.Images?.Any() == true)
                        {
                            <div class="mt-2">
                                <div class="row g-2">
                                    @foreach (var img in review.Images)
                                    {
                                        <div class="col-auto">
                                            <img src="@img.ImageUrl" class="img-thumbnail" style="max-width:100px;">
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        <small>@review.CreatedDate.ToString("dd/MM/yyyy HH:mm")</small>
                    </div>
                }
            }
            else
            {
                <p class="no-review">Chưa có bình luận nào cho sản phẩm này.</p>
            }

            <!-- Form bình luận -->
            <h3 class="mt-4">Viết bình luận</h3>
            <form asp-action="AddReview" method="post" enctype="multipart/form-data">
                <input type="hidden" name="TargetId" value="@Model.Product.Id" />
                <input type="hidden" name="TargetType" value="Product" />

                <div class="mb-3">
                    <label class="form-label">Đánh giá:</label>
                    <div class="rating-input">
                        <input type="hidden" name="Rating" id="ratingValue" value="0" />
                        <i class="star far fa-star" data-value="1"></i>
                        <i class="star far fa-star" data-value="2"></i>
                        <i class="star far fa-star" data-value="3"></i>
                        <i class="star far fa-star" data-value="4"></i>
                        <i class="star far fa-star" data-value="5"></i>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Nội dung bình luận:</label>
                    <textarea class="form-control" name="Comment" rows="4"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Thêm hình ảnh:</label>
                    <input type="file" class="form-control" name="ReviewImages" multiple accept="image/*">
                </div>

                <button type="submit" class="btn btn-primary">Gửi bình luận</button>
            </form>
        </div>
    </div>
</div>

<style>
    /* Tổng thể */
    body {
        background-color: #FFF0F5;
        font-family: 'Segoe UI', sans-serif;
    }

    /* Tiêu đề */
    h2, h3, .product-title {
        color: #FF6185;
        font-weight: 700;
    }

    /* Card sản phẩm */
    .product-card {
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
    }

    .main-product-img {
        border: 3px solid #FFB6C1;
        border-radius: 8px;
    }

    .product-thumbnail {
        border: 2px solid #FFB6C1;
        cursor: pointer;
        transition: transform .2s ease, border-color .2s ease;
    }

        .product-thumbnail:hover {
            transform: scale(1.05);
            border-color: #FF6185;
        }

    /* Giá */
    .product-price .text-danger {
        color: #FF6185 !important;
    }

    .badge.bg-danger {
        background-color: #FF6185 !important;
    }

    /* Hộp hành động */
    .product-detail-actions-container {
        background-color: #FFF0F5;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #FFB6C1;
    }

    /* Flavors */
    .flavor-option-label {
        background-color: #FFB6C1;
        color: #fff;
        border: 2px solid #FF6185;
        padding: 6px 12px;
        margin: 4px 6px 0 0;
        border-radius: 20px;
        cursor: pointer;
        transition: background-color .3s ease, transform .2s ease;
    }

        .flavor-option-label:hover {
            transform: scale(1.05);
        }

    .flavor-radio:checked + .flavor-option-label {
        background-color: #FF6185;
        color: #fff;
    }

    /* Buttons */
    .btn-primary {
        background-color: #FF6185;
        border-color: #FF6185;
        font-weight: 600;
    }

        .btn-primary:hover {
            background-color: #e05575;
            border-color: #e05575;
        }

    .btn-outline-dark {
        border-color: #FF6185;
        color: #FF6185;
    }

        .btn-outline-dark:hover {
            background-color: #FF6185;
            color: white;
        }

    /* Rating */
    .rating-input .star {
        font-size: 1.5rem;
        color: #FF6185 !important;
        cursor: pointer;
        transition: transform .2s ease, color .2s ease;
    }

    /* Review box */
    .review-box {
        background-color: #fff;
        border-left: 4px solid #FF6185;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

        .review-box strong {
            color: #FF6185;
        }

        .review-box .fa-star, .review-box .fa-star-half-alt {
            color: #FF6185;
        }

            .review-box .fa-star:not(.fas), .review-box .far.fa-star {
                color: #ccc;
            }

        .review-box img {
            border: 2px solid #FFB6C1;
            border-radius: 6px;
        }

    .no-review {
        color: #999;
        font-style: italic;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Đồng bộ hidden inputs ngay khi load
        updateHiddenInputs();

        // Sự kiện change cho dropdown số lượng
        var quantitySelect = document.getElementById('quantitySelect');
        if (quantitySelect) {
            quantitySelect.addEventListener('change', updateHiddenInputs);
        }

        // Sự kiện change cho radio flavor
        var flavorRadios = document.querySelectorAll('input[name="flavor"]');
        flavorRadios.forEach(function(radio) {
            radio.addEventListener('change', updateHiddenInputs);
        });

        // Bắt submit AddToCart: chặn vượt tồn
        var addToCartForm = document.getElementById('addToCartForm');
        if (addToCartForm) {
            addToCartForm.addEventListener('submit', function(event) {
                updateHiddenInputs();

                var qty = parseInt(document.getElementById('hiddenQuantity').value || '1');
                var available = parseInt((document.getElementById('quantitySelect')?.dataset?.available) || '0');

                if (qty > available) {
                    event.preventDefault();
                    alert('Số lượng bạn chọn vượt quá tồn kho (' + available + '). Vui lòng giảm số lượng.');
                }
            });
        }
    });

    // Cập nhật hidden inputs cho AddToCart
    function updateHiddenInputs() {
        var qSel = document.getElementById('quantitySelect');
        if (qSel) {
            document.getElementById('hiddenQuantity').value = qSel.value;
        }

        var selectedFlavorRadio = document.querySelector('input[name="flavor"]:checked');
        document.getElementById('hiddenFlavor').value = selectedFlavorRadio ? selectedFlavorRadio.value : '';
    }

    // Mua ngay (có chặn client vượt tồn, server vẫn check lại)
    function buyNow() {
        var productId = "@Model.Product.Id";
        var qSel = document.getElementById('quantitySelect');
        var quantity = qSel ? qSel.value : 1;
        var available = parseInt((qSel?.dataset?.available) || '0');

        if (parseInt(quantity) > available) {
            alert('Số lượng bạn chọn vượt quá tồn kho (' + available + '). Vui lòng giảm số lượng.');
            return;
        }

        var selectedFlavorRadio = document.querySelector('input[name="flavor"]:checked');
        var flavor = selectedFlavorRadio ? selectedFlavorRadio.value : '';

        window.location.href = `/ShoppingCart/Checkout?isBuyNow=true&buyNowProductId=${productId}&buyNowQuantity=${quantity}&buyNowFlavor=${encodeURIComponent(flavor)}`;
    }

    // Đổi ảnh chính khi click thumbnail
    document.addEventListener('DOMContentLoaded', function() {
        var mainImage = document.getElementById('mainProductImage');
        var thumbnails = document.querySelectorAll('.img-thumbnail');
        thumbnails.forEach(function(thumbnail) {
            thumbnail.addEventListener('click', function() {
                mainImage.src = this.src;
            });
        });
    });

    // Rating hiển thị sao
    document.addEventListener('DOMContentLoaded', function () {
        const stars = document.querySelectorAll('.rating-input .star');
        const ratingValueInput = document.getElementById('ratingValue');
        let currentRating = parseInt(ratingValueInput.value) || 0;

        function updateStarAppearance(rating) {
            stars.forEach(star => {
                const value = parseInt(star.dataset.value);
                if (value <= rating) {
                    star.classList.remove('far'); star.classList.add('fas');
                } else {
                    star.classList.remove('fas'); star.classList.add('far');
                }
            });
        }

        updateStarAppearance(currentRating);

        stars.forEach(star => {
            star.addEventListener('mouseover', () => {
                const hoverRating = parseInt(star.dataset.value);
                updateStarAppearance(hoverRating);
            });
            star.addEventListener('mouseout', () => {
                updateStarAppearance(currentRating);
            });
            star.addEventListener('click', () => {
                const clickedRating = parseInt(star.dataset.value);
                currentRating = clickedRating;
                ratingValueInput.value = clickedRating;
                updateStarAppearance(currentRating);
            });
        });
    });
</script>
