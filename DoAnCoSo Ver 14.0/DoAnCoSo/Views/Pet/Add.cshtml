@model DoAnCoSo.Models.Pet

@{
    ViewData["Title"] = "🐶 Thêm hồ sơ thú cưng";
}

<link rel="stylesheet" href="~/css/booking.css" />

<div class="container my-5">
    <div class="booking-card mx-auto" style="max-width: 750px;">
        <h2 class="booking-title text-center mb-4">@ViewData["Title"]</h2>

        <form asp-action="Add" method="post" enctype="multipart/form-data">
            <!-- Thông tin cơ bản -->
            <h5><span class="section-icon">📋</span> Thông tin cơ bản</h5>
            <div class="row g-3">

                <div class="col-md-6">
                    <label asp-for="Name" class="form-label">Tên thú cưng</label>
                    <input asp-for="Name" class="form-control" required />
                </div>

                <div class="col-md-6">
                    <label asp-for="Type" class="form-label">Loại</label>
                    <select asp-for="Type" id="PetType" class="form-select">
                        <option value="Chó">Chó</option>
                        <option value="Mèo">Mèo</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label asp-for="Breed" class="form-label">Giống</label>
                    <input asp-for="Breed" id="PetBreed" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label asp-for="DateOfBirth" class="form-label">Ngày sinh</label>
                    <input asp-for="DateOfBirth"
                           type="text"
                           id="datePicker"
                           class="form-control"
                           placeholder="Chọn ngày sinh..." />
                </div>

                <div class="col-md-3">
                    <label asp-for="Gender" class="form-label">Giới tính</label>
                    <select asp-for="Gender" class="form-select">
                        <option value="Male">Đực</option>
                        <option value="Female">Cái</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label asp-for="Age" class="form-label">Tuổi</label>
                    <input asp-for="Age" type="text" class="form-control" id="age" readonly />
                </div>

                <div class="col-md-6">
                    <label asp-for="Color" class="form-label">Màu sắc</label>
                    <input asp-for="Color" id="PetColor" class="form-control" />
                </div>

                <div class="col-12">
                    <label asp-for="DistinguishingMarks" class="form-label">Dấu hiệu nhận dạng</label>
                    <input asp-for="DistinguishingMarks" id="PetMarks" class="form-control" />
                </div>

            </div>

            <!-- Thông tin thể chất -->
            <h5 class="mt-4"><span class="section-icon">⚖️</span> Thông tin thể chất</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Weight" class="form-label">Cân nặng (kg)</label>
                    <input asp-for="Weight" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label asp-for="Height" class="form-label">Chiều cao (cm)</label>
                    <input asp-for="Height" class="form-control" />
                </div>
            </div>

            <!-- Thông tin sức khỏe -->
            <h5 class="mt-4"><span class="section-icon">🩺</span> Thông tin sức khỏe</h5>
            <div class="mb-3">
                <label asp-for="VaccinationRecords" class="form-label">Hồ sơ tiêm phòng</label>
                <textarea asp-for="VaccinationRecords" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="MedicalHistory" class="form-label">Tiền sử bệnh</label>
                <textarea asp-for="MedicalHistory" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="Allergies" class="form-label">Dị ứng</label>
                <textarea asp-for="Allergies" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="DietPreferences" class="form-label">Chế độ ăn</label>
                <textarea asp-for="DietPreferences" class="form-control" rows="2"></textarea>
            </div>  

            <div class="mb-3">
                <label asp-for="HealthNotes" class="form-label">Ghi chú sức khỏe</label>
                <textarea asp-for="HealthNotes" class="form-control" rows="2"></textarea>
            </div>

            <!-- Hình ảnh -->
            <div class="mb-3">
                <label asp-for="ImageUrl" class="form-label">Ảnh thú cưng</label>
                <input id="petImage" name="imageFile" type="file" class="form-control" accept="image/*" />
            </div>

            <!-- Nút AI -->
            <button type="button" id="btnAI" class="btn btn-warning w-100 mb-3">
                🔍 Phân tích ảnh bằng AI
            </button>

            <!-- Kết quả AI -->
            <div class="mb-3">
                <label asp-for="AI_AnalysisResult" class="form-label">Kết quả phân tích AI</label>
                <textarea asp-for="AI_AnalysisResult"
                          id="AI_AnalysisResult"
                          class="form-control"
                          rows="3" readonly
                          placeholder="AI sẽ tự động cập nhật sau khi phân tích..."></textarea>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a asp-action="Index" class="btn btn-secondary px-4 py-2 rounded-pill shadow-sm">
                    ← Quay lại
                </a>
                <button type="submit" class="btn btn-pink px-4 py-2 rounded-pill shadow-sm">💾 Lưu hồ sơ</button>
            </div>
        </form>
    </div>
</div>

<style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }
</style>

<!-- SCRIPT TÍNH TUỔI + AI -->
<script>
    // ============================
    // 1) Script TÍNH TUỔI (GIỮ NGUYÊN)
    // ============================
    document.addEventListener("DOMContentLoaded", function () {
        const ageInput = document.getElementById("age");
        const dobInput = document.getElementById("datePicker");
        if (!dobInput) return;

        function updateAge(dob) {
            if (!dob) {
                ageInput.value = '';
                ageInput.dataset.realAge = '';
                return;
            }

            const today = new Date();
            let years = today.getFullYear() - dob.getFullYear();
            let months = today.getMonth() - dob.getMonth();
            const days = today.getDate() - dob.getDate();

            if (months < 0 || (months === 0 && days < 0)) {
                years--;
                months += 12;
            }

            if (months >= 6) years++;

            ageInput.dataset.realAge = years >= 0 ? years : 0;
            ageInput.value = years > 0 ? years : "<1";
        }

        const dobPicker = flatpickr(dobInput, {
            dateFormat: "Y/m/d",
            altInput: true,
            altFormat: "d/m/Y",
            locale: "vn",
            maxDate: "today",
            disableMobile: true,
            onChange: function (selectedDates) {
                if (selectedDates.length) updateAge(selectedDates[0]);
            }
        });

        if (dobPicker.selectedDates.length) {
            updateAge(dobPicker.selectedDates[0]);
        }

        const form = ageInput.closest("form");
        if (form) {
            form.addEventListener("submit", function () {
                ageInput.value = ageInput.dataset.realAge || '';
            });
        }
    });


    // =====================================================
    // 2) SCRIPT AI PHÂN TÍCH ẢNH + TỰ DỊCH SANG TIẾNG VIỆT
    // =====================================================

    // HÀM cleanText() – loại bỏ ký tự dư thừa
    function cleanText(text) {
        if (!text) return "";
        return text
            .replace(/[\[\]\"]/g, "")   // bỏ dấu [, ], "
            .replace(/\s+/g, " ")        // gom nhiều space thành 1
            .replace(/,$/, "")           // bỏ dấu phẩy cuối
            .trim();
    }

    // HÀM translate() – gọi AI dịch tiếng Anh → tiếng Việt
    async function translate(text) {
        let res = await fetch("@Url.Action("Translate", "AI")", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
        });

        let raw = await res.text();
        let data = JSON.parse(raw);
        return cleanText(data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || text);
    }

    // Nút phân tích ảnh
    document.getElementById("btnAI").onclick = async () => {
        let file = document.getElementById("petImage").files[0];
        if (!file) {
            alert("⚠️ Vui lòng chọn ảnh trước!");
            return;
        }

        let formData = new FormData();
        formData.append("image", file);

        let res = await fetch("@Url.Action("Analyze", "AI")", {
            method: "POST",
            body: formData
        });

        let raw = await res.text();
        console.log("RAW RESPONSE:", raw);

        let data;
        try {
            data = JSON.parse(raw);
        } catch {
            alert("❌ API không trả JSON hợp lệ!");
            return;
        }

        let aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!aiText) {
            alert("❌ Không đọc được dữ liệu AI!");
            return;
        }

        document.getElementById("AI_AnalysisResult").value = aiText;

        // Parse JSON AI trả về
        let petInfo;
        try {
            petInfo = JSON.parse(aiText);
        } catch {
            alert("❌ AI trả JSON không hợp lệ!");
            return;
        }

        // ============================
        //  TỰ DỊCH + FILL FORM
        // ============================

        // TYPE (select Chó/Mèo)
        if (petInfo.type) {
            translate(petInfo.type).then(vi => {
                let cleaned = cleanText(vi);
                if (cleaned.includes("Mèo")) document.getElementById("PetType").value = "Mèo";
                else document.getElementById("PetType").value = "Chó";
            });
        }

        // BREED
        if (petInfo.breed) {
            translate(petInfo.breed).then(vi => {
                document.getElementById("PetBreed").value = cleanText(vi);
            });
        }

        // COLOR
        if (petInfo.color) {
            translate(petInfo.color).then(vi => {
                document.getElementById("PetColor").value = cleanText(vi);
            });
        }

        // MARKS (Dấu hiệu nhận dạng)
        if (petInfo.marks) {
            translate(petInfo.marks).then(vi => {
                document.getElementById("PetMarks").value = cleanText(vi);
            });
        }

        alert("🎉 AI đã phân tích & dịch tiếng Việt thành công!");
    };

</script>

