@model DoAnCoSo.ViewModels.SpaBookingViewModel
@using DoAnCoSo.Models

@{
    bool isUpdate = Model.IsUpdate;
    ViewData["Title"] = isUpdate ? "✏️ Cập nhật lịch Spa cho thú cưng 🐾" : "🧼 Đặt lịch Spa cho thú cưng 🐾";
    var spaServices = ViewBag.SpaServices as List<Service> ?? new List<Service>();
    var spaPricings = ViewBag.SpaPricings as List<SpaPricing> ?? new List<SpaPricing>();
    var users = (ViewBag.Users as List<ApplicationUser>)?.OrderBy(u => u.FullName).ToList() ?? new List<ApplicationUser>();
    var selectedUserId = !string.IsNullOrEmpty(Model.UserId)
                         ? Model.UserId
                         : (users.FirstOrDefault()?.Id ?? "");
}

<link rel="stylesheet" href="~/css/booking.css" />

<div class="container my-5">
    <div class="booking-card mx-auto" style="max-width: 750px;">
        <h2 class="booking-title text-center mb-4">@ViewData["Title"]</h2>

        <form asp-action="@(Model.IsUpdate ? "UpdateAppointmentSpa" : "AppointmentSpa")" method="post">
            <input type="hidden" asp-for="AppointmentId" />

            <!-- 0️⃣ Chọn khách hàng (admin) -->
            <h5><span class="section-icon">👥</span>Chọn khách hàng</h5>
            <div class="mb-3">
                <label for="userSelect" class="form-label">Khách hàng</label>
                <select id="userSelect" name="UserId" class="form-select" required>
                    @foreach (var u in users)
                    {
                        <option value="@u.Id" selected="@(u.Id == selectedUserId ? "selected" : "")">
                            @u.FullName
                        </option>
                    }
                </select>
            </div>

            <!-- 1️⃣ Thông tin chủ nuôi -->
            <h5><span class="section-icon">👤</span>Thông tin chủ nuôi</h5>
            <div class="mb-3">
                <label asp-for="OwnerPhoneNumber" class="form-label">Số điện thoại</label>
                <input asp-for="OwnerPhoneNumber" class="form-control"/>
            </div>

            <!-- 2️⃣ Thú cưng -->
            <h5><span class="section-icon">🐾</span>Chọn thú cưng</h5>
            <div class="mb-3">
                <label class="form-label">Thú cưng có sẵn</label>
                <select id="existingPetSelect" class="form-select">
                    @foreach (var pet in (Model.UserPets ?? new List<Pet>()).OrderBy(p => p.Name))
                    {
                        <option value="@pet.PetId"
                                data-name="@pet.Name"
                                data-type="@pet.Type"
                                data-breed="@pet.Breed"
                                data-age="@pet.Age"
                                data-weight="@pet.Weight"
                                selected="@(Model.ExistingPetId == pet.PetId ? "selected" : "")">
                            @pet.Name
                        </option>
                    }
                </select>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label asp-for="PetName" class="form-label">Tên thú cưng</label>
                    <input asp-for="PetName" class="form-control" readonly />
                </div>
                <div class="col-md-6">
                    <label asp-for="PetType" class="form-label">Loại</label>
                    <input asp-for="PetType" class="form-control" readonly />
                </div>
                <div class="col-md-6">
                    <label asp-for="PetBreed" class="form-label">Giống</label>
                    <input asp-for="PetBreed" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label asp-for="PetAge" class="form-label">Tuổi</label>
                    <input asp-for="PetAge" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label asp-for="PetWeight" class="form-label">Cân nặng</label>
                    <div class="input-group">
                        <input asp-for="PetWeight" class="form-control" id="PetWeight" readonly />
                        <span class="input-group-text">kg</span>
                    </div>
                </div>
            </div>

            <input type="hidden" asp-for="ExistingPetId" id="ExistingPetId" />

            <!-- 3️⃣ Dịch vụ -->
            <h5><span class="section-icon">🧴</span>Chọn dịch vụ Spa</h5>
            <div class="mb-3">
                <label asp-for="ServiceId" class="form-label">Dịch vụ</label>
                <select asp-for="ServiceId" class="form-select" id="serviceSelect" required>
                    @foreach (var service in spaServices)
                    {
                        var pricing = spaPricings?.FirstOrDefault(p => p.ServiceId == service.ServiceId);
                        <option value="@service.ServiceId"
                                data-priceunder5="@(pricing?.PriceUnder5kg ?? 0)"
                                data-price5to12="@(pricing?.Price5To12kg ?? 0)"
                                data-price12to25="@(pricing?.Price12To25kg ?? 0)"
                                data-priceover25="@(pricing?.PriceOver25kg ?? 0)"
                                selected="@(Model.ServiceId == service.ServiceId ? "selected" : "")">
                            @service.Name
                        </option>
                    }
                </select>
            </div>

            <!-- 4️⃣ Giá -->
            <h5><span class="section-icon">💰</span>Giá dịch vụ</h5>
            <div class="mb-3">
                <input type="text" class="form-control fw-bold text-danger" id="calculatedPrice" value="0 VNĐ" readonly />
            </div>

            <!-- 5️⃣ Thời gian -->
            <h5><span class="section-icon">📅</span>Thời gian hẹn</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="AppointmentDate" class="form-label">Ngày hẹn</label>
                    <input asp-for="AppointmentDate" type="text" id="appointmentPicker" class="form-control" placeholder="Chọn ngày hẹn..." required />
                </div>
                <div class="col-md-6">
                    <label asp-for="AppointmentTime" class="form-label">Giờ hẹn</label>
                    <input asp-for="AppointmentTime" type="time" class="form-control" required />
                </div>
            </div>

            <button type="submit" class="btn btn-pink w-100 mt-4">
                @(isUpdate ? "💾 Cập nhật lịch" : "📅 Đặt lịch ngay")
            </button>

        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const userSelect = document.getElementById("userSelect");
        const petSelect = document.getElementById("existingPetSelect");
        const serviceSelect = document.getElementById("serviceSelect");
        const priceInput = document.getElementById("calculatedPrice");

        const petNameInput = document.getElementById("PetName");
        const petTypeInput = document.getElementById("PetType");
        const petBreedInput = document.getElementById("PetBreed");
        const petAgeInput = document.getElementById("PetAge");
        const petWeightInput = document.getElementById("PetWeight");
        const existingPetIdInput = document.getElementById("ExistingPetId");
        const ownerPhoneInput = document.getElementById("OwnerPhoneNumber");
        const appointmentPicker = document.getElementById("appointmentPicker");

        function parseWeight(weightStr) {
            if (!weightStr) return 0;
            const cleaned = weightStr.replace(",", ".").replace(/[^\d.]/g, "");
            return parseFloat(cleaned) || 0;
        }

        function updatePrice() {
            const selectedPet = petSelect.selectedOptions[0];
            const selectedService = serviceSelect.selectedOptions[0];
            if (!selectedPet || !selectedService) { priceInput.value = "0 VNĐ"; return; }

            const weight = parseWeight(selectedPet.dataset.weight);
            let price = 0;
            if (weight < 5) price = parseFloat(selectedService.dataset.priceunder5) || 0;
            else if (weight <= 12) price = parseFloat(selectedService.dataset.price5to12) || 0;
            else if (weight <= 25) price = parseFloat(selectedService.dataset.price12to25) || 0;
            else price = parseFloat(selectedService.dataset.priceover25) || 0;

            priceInput.value = price.toLocaleString("vi-VN") + " VNĐ";
        }

        function updatePetInfo() {
            const selectedPet = petSelect.selectedOptions[0];
            if (!selectedPet) return;

            petNameInput.value = selectedPet.dataset.name || "";
            petTypeInput.value = selectedPet.dataset.type || "";
            petBreedInput.value = selectedPet.dataset.breed || "";
            petAgeInput.value = selectedPet.dataset.age || "";
            petWeightInput.value = selectedPet.dataset.weight || "";
            existingPetIdInput.value = selectedPet.value;

            updatePrice();
        }

        // Load pet và số điện thoại khi đổi khách hàng
        userSelect.addEventListener("change", function () {
            const userId = userSelect.value;
            fetch(`/Admin/Service/GetUserPetsAndPhone?userId=${userId}`)
                .then(res => res.json())
                .then(data => {
                    ownerPhoneInput.value = data.phone || "";
                    petSelect.innerHTML = "";
                    data.pets.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
                        const option = document.createElement("option");
                        option.value = p.petId;
                        option.dataset.name = p.name;
                        option.dataset.type = p.type;
                        option.dataset.breed = p.breed;
                        option.dataset.age = p.age;
                        option.dataset.weight = p.weight;
                        option.textContent = p.name;
                        petSelect.appendChild(option);
                    });
                    if (petSelect.options.length > 0) {
                        petSelect.selectedIndex = 0;
                        updatePetInfo();
                    }
                });
        });

        petSelect.addEventListener("change", updatePetInfo);
        serviceSelect.addEventListener("change", updatePrice);

        // ✅ Load mặc định khi mở trang
        if (userSelect.options.length > 0) {
            // Nếu update, chọn user từ Model.UserId, không chọn 0
            if (@(Model.IsUpdate.ToString().ToLower())) {
                for (let i = 0; i < userSelect.options.length; i++) {
                    if (userSelect.options[i].value === "@Model.UserId") {
                        userSelect.selectedIndex = i;
                        break;
                    }
                }
                // Load lại pets theo userId
                const event = new Event("change");
                userSelect.dispatchEvent(event);

                // Chọn pet hiện tại theo Model.ExistingPetId sau khi pets được load
                setTimeout(() => {
                    for (let i = 0; i < petSelect.options.length; i++) {
                        if (petSelect.options[i].value === "@Model.ExistingPetId") {
                            petSelect.selectedIndex = i;
                            updatePetInfo();
                            break;
                        }
                    }
                }, 50); // delay để pets được fetch từ server
            } else {
                // Form Add
                userSelect.selectedIndex = 0;
                userSelect.dispatchEvent(new Event("change"));
            }
        }

        if (serviceSelect.options.length > 0) {
            // Chọn service hiện tại nếu Update, ngược lại chọn đầu tiên
            if (@(Model.IsUpdate.ToString().ToLower())) {
                for (let i = 0; i < serviceSelect.options.length; i++) {
                    if (serviceSelect.options[i].value === "@Model.ServiceId") {
                        serviceSelect.selectedIndex = i;
                        updatePrice();
                        break;
                    }
                }
            } else {
                serviceSelect.selectedIndex = 0;
                updatePrice();
            }
        }

        // Flatpickr ngày mặc định hôm nay
        flatpickr("#appointmentPicker", {
            dateFormat: "d/m/Y",
            altInput: true,
            altFormat: "d/m/Y",
            locale: "vn",
            disableMobile: true,
            minDate: "today",
            defaultDate: "@(Model.AppointmentDate.ToString("dd/MM/yyyy"))"
        });
    });
</script>
