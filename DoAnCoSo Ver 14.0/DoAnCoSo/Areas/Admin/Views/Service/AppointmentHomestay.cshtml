@model DoAnCoSo.ViewModels.HomestayBookingViewModel
@using DoAnCoSo.Models

@{
    bool isUpdate = Model.IsUpdate;
    ViewData["Title"] = isUpdate ? "✏️ Cập nhật lịch Homestay 🐾" : "🏨 Đặt lịch Homestay 🐶🐱";

    var homestayServices = ViewBag.HomestayServices as List<Service> ?? new List<Service>();
    var users = (ViewBag.Users as List<ApplicationUser>)?.OrderBy(u => u.FullName).ToList() ?? new List<ApplicationUser>();
    var selectedUserId = !string.IsNullOrEmpty(Model.UserId)
                        ? Model.UserId
                        : (users.FirstOrDefault()?.Id ?? "");
}

<link rel="stylesheet" href="~/css/booking.css" />

<div class="container my-5">
    <div class="booking-card mx-auto" style="max-width: 750px;">
        <h2 class="booking-title text-center mb-4">@ViewData["Title"]</h2>

        <form asp-action="@(isUpdate ? "UpdateAppointmentHomestay" : "AppointmentHomestay")" method="post">
            <input type="hidden" asp-for="AppointmentId" />

            <!-- 0️⃣ Chọn khách hàng (admin) -->
            <h5><span class="section-icon">👥</span>Chọn khách hàng</h5>
            <div class="mb-3">
                <label for="userSelect" class="form-label">Khách hàng</label>
                <select id="userSelect" name="UserId" class="form-select" required>
                    @foreach (var u in users)
                    {
                        <option value="@u.Id" selected="@(u.Id == selectedUserId ? "selected" : "")">
                            @u.FullName
                        </option>
                    }
                </select>
            </div>

            <!-- 1️⃣ Số điện thoại -->
            <h5><span class="section-icon">👤</span>Thông tin chủ nuôi</h5>
            <div class="mb-3">
                <label asp-for="OwnerPhoneNumber" class="form-label">Số điện thoại</label>
                <input asp-for="OwnerPhoneNumber" class="form-control" id="OwnerPhoneNumber"/>
            </div>

            <!-- 2️⃣ Thú cưng -->
            <h5><span class="section-icon">🐾</span>Chọn thú cưng</h5>
            <div class="mb-3">
                <label class="form-label">Thú cưng có sẵn</label>
                <select id="existingPetSelect" class="form-select"></select>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label asp-for="PetName" class="form-label">Tên thú cưng</label>
                    <input asp-for="PetName" class="form-control" id="PetName" readonly />
                </div>
                <div class="col-md-6">
                    <label asp-for="PetType" class="form-label">Loại</label>
                    <input asp-for="PetType" class="form-control" id="PetType" readonly />
                </div>
                <div class="col-md-6">
                    <label asp-for="PetBreed" class="form-label">Giống</label>
                    <input asp-for="PetBreed" class="form-control" id="PetBreed" readonly />
                </div>
                <div class="col-md-3">
                    <label asp-for="PetAge" class="form-label">Tuổi</label>
                    <input asp-for="PetAge" class="form-control" id="PetAge" readonly />
                </div>
                <div class="col-md-3">
                    <label asp-for="PetWeight" class="form-label">Cân nặng</label>
                    <div class="input-group">
                        <input asp-for="PetWeight" class="form-control" id="PetWeight" readonly />
                        <span class="input-group-text">kg</span>
                    </div>
                </div>
            </div>

            <input type="hidden" asp-for="ExistingPetId" id="ExistingPetId" />

            <!-- 3️⃣ Loại phòng -->
            <h5><span class="section-icon">🛏️</span>Chọn loại phòng Homestay</h5>
            <div class="mb-3">
                <label asp-for="ServiceId" class="form-label">Loại phòng</label>
                <select asp-for="ServiceId" class="form-select" id="serviceSelect" required
                        asp-items="@(new SelectList(homestayServices, "ServiceId", "Name"))">
                </select>
            </div>

            <!-- 4️⃣ Thời gian -->
            <h5><span class="section-icon">📅</span>Thời gian lưu trú</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="StartDate" class="form-label">Ngày bắt đầu</label>
                    <input asp-for="StartDate"
                           type="text"
                           id="startPicker"
                           class="form-control"
                           placeholder="Chọn ngày bắt đầu..."
                           required />
                </div>
                <div class="col-md-6">
                    <label asp-for="EndDate" class="form-label">Ngày kết thúc</label>
                    <input asp-for="EndDate"
                           type="text"
                           id="endPicker"
                           class="form-control"
                           placeholder="Chọn ngày kết thúc..."
                           required />
                </div>
            </div>

            <button type="submit" class="btn btn-pink w-100 mt-4">
                @(isUpdate ? "💾 Cập nhật lịch" : "📦 Đặt lịch ngay")
            </button>
        </form>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const userSelect = document.getElementById("userSelect");
    const petSelect = document.getElementById("existingPetSelect");
    const ownerPhoneInput = document.getElementById("OwnerPhoneNumber");

    const petName = document.getElementById("PetName");
    const petType = document.getElementById("PetType");
    const petBreed = document.getElementById("PetBreed");
    const petAge = document.getElementById("PetAge");
    const petWeight = document.getElementById("PetWeight");
    const existingPetIdInput = document.getElementById("ExistingPetId");

    function loadPets() {
        const userId = userSelect.value;
        fetch(`/Admin/Service/GetUserPetsAndPhone?userId=${userId}`)
            .then(res => res.json())
            .then(data => {
                ownerPhoneInput.value = data.phone || "";
                petSelect.innerHTML = "";
                data.pets.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
                    const option = document.createElement("option");
                    option.value = p.petId;
                    option.dataset.name = p.name;
                    option.dataset.type = p.type;
                    option.dataset.breed = p.breed;
                    option.dataset.age = p.age;
                    option.dataset.weight = p.weight;
                    option.textContent = p.name;
                    petSelect.appendChild(option);
                });

                if (petSelect.options.length > 0) {
                    @* Nếu là update thì chọn ExistingPetId *@
                    const existingId = "@Model.ExistingPetId";
                    if ("@isUpdate" === "True" && existingId) {
                        for (let i = 0; i < petSelect.options.length; i++) {
                            if (petSelect.options[i].value === existingId) {
                                petSelect.selectedIndex = i;
                                break;
                            }
                        }
                    } else {
                        petSelect.selectedIndex = 0;
                    }
                    updatePetInfo();
                }
            });
    }

    function updatePetInfo() {
        const opt = petSelect.selectedOptions[0];
        if (!opt) return;
        petName.value = opt.dataset.name || "";
        petType.value = opt.dataset.type || "";
        petBreed.value = opt.dataset.breed || "";
        petAge.value = opt.dataset.age || "";
        petWeight.value = opt.dataset.weight || "";
        existingPetIdInput.value = opt.value;
    }

    userSelect.addEventListener("change", loadPets);
    petSelect.addEventListener("change", updatePetInfo);

    // Load mặc định
    if (userSelect.options.length > 0) {
        @* Nếu update thì chọn UserId từ model *@
        const selectedUserId = "@Model.UserId";
        if ("@isUpdate" === "True" && selectedUserId) {
            for (let i = 0; i < userSelect.options.length; i++) {
                if (userSelect.options[i].value === selectedUserId) {
                    userSelect.selectedIndex = i;
                    break;
                }
            }
        } else {
            userSelect.selectedIndex = 0;
        }
        userSelect.dispatchEvent(new Event("change"));
    }

    // Flatpickr
    const startPicker = flatpickr("#startPicker", {
        dateFormat: "Y/m/d",
        altInput: true,
        altFormat: "d/m/Y",
        locale: "vn",
        disableMobile: true,
        minDate: "today",
        defaultDate: "@(Model.StartDate.ToString("yyyy/MM/dd"))",
        onChange: function(selectedDates) {
            if (selectedDates.length > 0) endPicker.set('minDate', selectedDates[0]);
        }
    });

    const endPicker = flatpickr("#endPicker", {
        dateFormat: "Y/m/d",
        altInput: true,
        altFormat: "d/m/Y",
        locale: "vn",
        disableMobile: true,
        minDate: "today",
        defaultDate: "@(Model.EndDate.ToString("yyyy/MM/dd"))",
        onChange: function(selectedDates) {
            if (selectedDates.length > 0) startPicker.set('maxDate', selectedDates[0]);
        }
    });
});
</script>
