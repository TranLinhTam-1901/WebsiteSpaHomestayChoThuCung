@model DoAnCoSo.Models.Pet

@{
    ViewData["Title"] = "🐶 Thêm hồ sơ thú cưng";
}

<link rel="stylesheet" href="~/css/booking.css" />

<div class="container my-5">
    <div class="booking-card mx-auto" style="max-width: 750px;">
        <h2 class="booking-title text-center mb-4">@ViewData["Title"]</h2>

        <form asp-action="Add" method="post" enctype="multipart/form-data">
            <!-- Thông tin cơ bản -->
            <h5><span class="section-icon">📋</span> Thông tin cơ bản</h5>
            <div class="row g-3">
                <!-- Chủ sở hữu -->
                <div class="col-md-5">
                    <label asp-for="UserId" class="form-label">Chủ sở hữu</label>
                    <select asp-for="UserId" class="form-select" asp-items="ViewBag.UserId">
                    </select>
                </div>

                <!-- Tên thú cưng -->
                <div class="col-md-5">
                    <label asp-for="Name" class="form-label">Tên thú cưng</label>
                    <input asp-for="Name" class="form-control" required />
                </div>

                <!-- Loại -->
                <div class="col-md-2">
                    <label asp-for="Type" class="form-label">Loại</label>
                    <select asp-for="Type" class="form-select">
                        <option value="Chó">Chó</option>
                        <option value="Mèo">Mèo</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label asp-for="Breed" class="form-label">Giống</label>
                    <input asp-for="Breed" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label asp-for="DateOfBirth" class="form-label">Ngày sinh</label>
                    <input asp-for="DateOfBirth"
                           type="text"
                           id="datePicker"
                           class="form-control"
                           placeholder="Chọn ngày sinh..." />
                </div>

                <div class="col-md-3">
                    <label asp-for="Gender" class="form-label">Giới tính</label>
                    <select asp-for="Gender" class="form-select">
                        <option value="Male">Đực</option>
                        <option value="Female">Cái</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label asp-for="Age" class="form-label">Tuổi</label>
                    <input asp-for="Age" type="text" class="form-control" id="age" readonly />
                </div>

                <div class="col-md-6">
                    <label asp-for="Color" class="form-label">Màu sắc</label>
                    <input asp-for="Color" class="form-control" />
                </div>

                <div class="col-12">
                    <label asp-for="DistinguishingMarks" class="form-label">Dấu hiệu nhận dạng</label>
                    <input asp-for="DistinguishingMarks" class="form-control" />
                </div>
            </div>

            <!-- Thông tin thể chất -->
            <h5 class="mt-4"><span class="section-icon">⚖️</span> Thông tin thể chất</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Weight" class="form-label">Cân nặng (kg)</label>
                    <input asp-for="Weight" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label asp-for="Height" class="form-label">Chiều cao (cm)</label>
                    <input asp-for="Height" class="form-control" />
                </div>
            </div>

            <!-- Thông tin sức khỏe -->
            <h5 class="mt-4"><span class="section-icon">🩺</span> Thông tin sức khỏe</h5>
            <div class="mb-3">
                <label asp-for="VaccinationRecords" class="form-label">Hồ sơ tiêm phòng</label>
                <textarea asp-for="VaccinationRecords" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="MedicalHistory" class="form-label">Tiền sử bệnh</label>
                <textarea asp-for="MedicalHistory" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="Allergies" class="form-label">Dị ứng</label>
                <textarea asp-for="Allergies" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="DietPreferences" class="form-label">Chế độ ăn</label>
                <textarea asp-for="DietPreferences" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label asp-for="HealthNotes" class="form-label">Ghi chú sức khỏe</label>
                <textarea asp-for="HealthNotes" class="form-control" rows="2"></textarea>
            </div>

            <!-- Hình ảnh -->
            <div class="mb-3">
                <label asp-for="ImageUrl" class="form-label">Ảnh thú cưng</label>
                <input name="imageFile" type="file" class="form-control" />
            </div>

            <!-- AI -->
            <div class="mb-3">
                <label asp-for="AI_AnalysisResult" class="form-label">Kết quả phân tích AI</label>
                <textarea asp-for="AI_AnalysisResult" class="form-control" rows="2" readonly placeholder="Tự động cập nhật sau"></textarea>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a asp-action="Index" class="btn btn-secondary">
                    ⬅️ Quay lại
                </a>
                <button type="submit" class="btn btn-pink">💾 Lưu hồ sơ</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Ẩn mũi tên trong input type=number */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield; /* Firefox */
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ageInput = document.getElementById("age");
        const dobInput = document.getElementById("datePicker");

        if (!dobInput) return;

        // Khởi tạo flatpickr riêng cho input ngày sinh
        const dobPicker = flatpickr(dobInput, {
            dateFormat: "d/m/Y",
            altInput: true,
            altFormat: "d/m/Y",
            locale: "vn",
            maxDate: "today",
            disableMobile: true,
            onChange: function (selectedDates) {
                updateAge(selectedDates[0]);
            }
        });

        // Khi load form, nếu có sẵn ngày sinh thì tính tuổi
        if (dobPicker.input.value) {
            const parts = dobPicker.input.value.split('/');
            if (parts.length === 3) {
                const dob = new Date(parts[2], parts[1] - 1, parts[0]);
                updateAge(dob);
            }
        }

        function updateAge(dob) {
            if (!dob) {
                ageInput.value = '';
                return;
            }

            const today = new Date();
            let years = today.getFullYear() - dob.getFullYear();
            let months = today.getMonth() - dob.getMonth();

            if (months < 0) {
                years--;
                months += 12;
            }

            if (years === 0 && months < 6) {
                ageInput.value = "< 1";
                ageInput.dataset.realAge = 0;
            }else {
                if (months >= 6) years++;
                ageInput.value = years;
                ageInput.dataset.realAge = years;
            }
        }

        // Khi submit form, gửi giá trị thật
        const form = ageInput.closest("form");
        if (form) {
            form.addEventListener("submit", function () {
                ageInput.value = ageInput.dataset.realAge || '';
            });
        }
    });
</script>
